<!DOCTYPE html>
<html>
  <head>
    <title>Проект "Комменты"</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="styles.css" />
  </head>

  <body>
    <div class="container">
      <ul class="comments"></ul>
      <div class="add-form">
        <input
          type="text"
          class="add-form-name"
          placeholder="Введите ваше имя"
        />
        <textarea
          type="textarea"
          class="add-form-text"
          placeholder="Введите ваш коментарий"
          rows="4"
        ></textarea>
        <div class="add-form-row">
          <button class="add-form-button">Написать</button>
        </div>
      </div>
    </div>
  </body>

  <script>
    "use strict";
    // Код писать здесь
    console.log("It works!");
    const commentNameInput = document.querySelector (".add-form-name");
    const commentTextInput = document.querySelector (".add-form-text");
    const addButton = document.querySelector (".add-form-button");
    const commentsBox = document.querySelector (".comments");
    const newDate = new Date().toLocaleString().slice(0, -3);
       
    let comments = [
      /*{
        name: 'Глеб Фокин',
        date: '12.02.22 12:18',
        comment: 'Это будет первый комментарий на этой странице',
        likes: 3,
        isLiked: false,
      },
      {
        name: 'Варвара Н.',
        date: '13.02.22 19:22',
        comment: 'Мне нравится как оформлена эта страница! ❤',
        likes: 75,
        isLiked: true,
      },
    */
    ]
    
    function renderComments() {
		const commentsListHtml = comments
    .map((comment, index) => {
			console.log(comment)
      return `
			<li class="comment" data-name="${comment.name}" data-text="${comment.text}" data-index="${index}">
				<div class="comment-header">
					<div>${comment.name}</div>
					<div>${comment.date}</div>
				</div>
				<div class="comment-body">
					<div class="comment-text" style="white-space:pre-line">
						${comment.text}
					</div>
				</div>
				<div class="comment-footer">
					<div class="likes">
						<span class="likes-counter">${comment.likes}</span>
						<button class="like-button ${comment.isLiked ? '-active-like' : ''}">
						</button>
					</div>
				</div>
			</li>
			`;
		}).join('');
		
		const commentsList = document.querySelector('.comments');
		commentsList.innerHTML = commentsListHtml;
		

		const commentListItems = commentsList.querySelectorAll('.comment');
		for (const commentListItem of commentListItems) {
			const likeButton = commentListItem.querySelector('.like-button');
			const commentIndex = commentListItem.dataset.index;
			const comment = comments[commentIndex];

			likeButton.addEventListener('click', (event) => {
				event.stopPropagation();				

				if (comment.isLiked) {
					comment.isLiked = false;
					comment.likes--;
				} else {
					comment.isLiked = true;
					comment.likes++;
				}

				renderComments();
			});
		}
	}
    


    function fetchComments () {
      return fetch(
        "https://wedev-api.sky.pro/api/v1/anastasija-pelyak/comments", 
        {
          method: "GET"
        }
      ).then((response) => {
        response.json().then((responseData) => {
    
        const appComments = responseData.comments.map((comment) => {
          return {
            name: comment.author.name,
            date: new Date(comment.date),
            likes: comment.likes,
            isLiked: false,
            text: comment.text,
          };
        });
        comments = appComments;
        renderComments();
        });
      });
    }
    fetchComments();
    
    function postComment() {
      return fetch(
        "https://wedev-api.sky.pro/api/v1/anastasija-pelyak/comments",
        {
          method: "POST",
          body: JSON.stringify({
            text: commentTextInput.value
              .replaceAll("&", "&amp;")
              .replaceAll("<", "&lt;")
              .replaceAll(">", "&gt;")
              .replaceAll('"', "&quot;")
              .replaceAll("QUOTE_BEGIN", "<div class='quote'>")
              .replaceAll("QUOTE_END", "</div>"),
              name: commentNameInput.value
              .replaceAll("&", "&amp;")
              .replaceAll("<", "&lt;")
              .replaceAll(">", "&gt;")
              .replaceAll('"', "&quot;")
              .replaceAll("QUOTE_BEGIN", "<div class='quote'>")
              .replaceAll("QUOTE_END", "</div>"),
          }),
        }
        ).then((response) => {
          response.json().then((responseData) => {
            fetchComments();
          });
		    });
    }        
    const initEventListeners = () => {
      const buttonElements = document.querySelectorAll('.like-button');
    
      for (const buttonElement of buttonElements) {
        buttonElement.addEventListener('click', () => {
          
          const index = buttonElement.dataset.index;
          
          if (comments[index].isLiked) {
            comments[index].isLiked = false;
            comments[index].likes--;
          } else {
            comments[index].isLiked = true;
            comments[index].likes++;
          }
    
          renderComments();
        });
      }
    };        
    
    addButton.addEventListener("click", () => {
      
      commentNameInput.classList.remove("error");

      if (commentNameInput.value === "") {
        commentNameInput.classList.add("error");
        return;
      }
      if (commentTextInput.value === "") {
        commentTextInput.classList.add("error");
        return;
      }
      postComment();
      
      commentNameInput.value = "";
      commentTextInput.value = "";
    });
  </script>
</html>
